---
title: "Docker를 이용한 서버 구축 - 직접 이미지 빌드하기"
category: "서버 구축"
author: kuper0201
tags: ['#server']
date: 2022-03-02
slug: server-with-docker03
thumbnail: cover.jpg
draft: true
---

## 서론

이전 글에서는 미리 제작되어 Docker Hub에 업로드 되어있는 이미지를 사용하는 방법에 대해 다뤘습니다.<br/>
이번 글에서는 이미지를 직접 빌드하고 Docker Hub에 업로드 하는 방법에 대한 글을 작성해 보겠습니다.

먼저 Docker 이미지를 생성하고 업로드 하기 위한 프로세스를 알아보겠습니다.
Docker 이미지를 생성하려면 아래와 같은 단계를 거쳐야 합니다.

1. Dockerfile 작성
2. 작성한 Dockerfile 빌드
3. 빌드된 이미지 Docker Hub에 업로드

첫 번째 단계에서 Dockerfile을 작성해야 한다고 하였으므로 Dockerfile이 무엇인지 먼저 알아보겠습니다.<br/>
Dockerfile은 사용자가 직접 이미지를 제작 할 수 있도록 Docker에서 제공하는 스크립트 문법입니다.<br/>
문법에 맞게 Dockerfile을 작성하고 빌드하면 Docker에서 사용할 수 있는 이미지가 생성됩니다.<br/>
그렇다면 Dockerfile을 작성하기 위한 문법을 알아 보겠습니다.

## DockerFile 문법

먼저 Dockerfile이라는 이름의 빈 파일을 하나 만들겠습니다.

```bash
touch Dockerfile
```

만들어진 Dockerfile에 필요한 내용들을 작성하면 됩니다.<br/>
그럼 가장 먼저 FROM 명령을 알아 보겠습니다.

### FROM 명령어

FROM 명령어는 베이스 이미지를 지정하는데 사용하는 명령어입니다.<br/>
베이스 이미지가 무엇인지 잠시 알아 보겠습니다.<br/>
APP은 OS상에서 구동되기 때문에 해당 APP과 호환되는 OS가 반드시 필요합니다.<br/>
OS의 구성 요소 중 커널은 호스트 시스템과 공유해서 사용하므로 필요하지 않지만 라이브러리, Shell과 같은 요소들은 여전히 필요합니다.<br/>
이러한 APP 구동에 필수적인 요소들을 미리 모아둔 것을 베이스 이미지라고 합니다.<br/>
다음과 같은 형식으로 베이스 이미지를 지정 할 수 있습니다.

```bash
FROM <이미지명>:<태그>
```

위의 형식은 <이미지명>에 해당하는 이미지의 <태그> 버전을 베이스 이미지로 사용하겠다는 의미입니다.<br/>
어떤 이미지든 베이스 이미지가 될 수 있으므로 필요성에 맞는 이미지를 선택해서 베이스 이미지로 사용하면 됩니다.<br/>
베이스 이미지가 준비되었으므로 구동할 APP을 설치하고 설정하는 작업이 필요합니다.

### RUN 명령어

RUN 명령어는 구동할 APP을 설치하고 설정하는 작업을 하기 위한 명령어입니다.<br/>
해당 명령어를 이용하면 Bash 혹은 ZSH등의 Shell에 명령을 내린 것과 같은 동작을 합니다.<br/>
형식은 아래와 같습니다.

```bash
RUN <Shell 명령어>
```

RUN 명령에 전달하는 Shell 명령어는 당연하게도 해당 명령이 실행되는 시점에 이미지에 존재 해야 합니다.<br/>
예를 들어 Ubuntu:latest 이미지를 베이스 이미지로 사용하는 이미지에서 ```RUN apt-get install -y nginx```를 실행하면 정상적으로 NGINX의 설치가 완료됩니다.<br/>
이는 베이스 이미지에 apt-get(Ubuntu 패키지 관리자) 명령어가 존재하기 때문입니다.<br/>
하지만 ```RUN apk add nginx```명령을 이용하면 설치가 이루어지지 않습니다.<br/>
apk명령은 Alpine 리눅스의 패키지 관리자 명령이기 때문에 Ubuntu에는 존재하지 않기 때문입니다.

### COPY 명령어

COPY 명령어는 호스트에 존재하는 파일을 이미지에 복사하는 명령어입니다.<br/>
이미지를 제작하다 보면 개발한 APP의 바이너리 또는 설정 파일 등을 이미지에 복사해야 하는 경우가 발생합니다.<br/>
이런 경우에 사용하는 명령어가 COPY 명령어입니다.

형식은 다음과 같습니다.

```bash
COPY <호스트 파일 경로> <이미지 파일 경로>
```

NGINX 컨테이너에서 다음과 같은 index.html 파일을 출력하려 한다고 가정하겠습니다. (index.html 파일은 Dockerfile과 같은 경로에 존재한다고 가정하겠습니다)

```html
<html>
	<body>
		<h1>The first Docker image!!!</h1>
	</body>
</html>
```

작성한 index.html 파일을 이미지에 복사해야 하는 상황입니다.

```COPY ./index.html /var/www/html/index.html``` 와 같이 작성하면 index.html 파일을 이미지에 복사 할 수 있습니다.

### CMD 명령어

CMD 명령어는 컨테이너의 시작점을 정의하는 명령어입니다.<br/>
컨테이너가 시작 할 때 어떤 프로세스가 작동하여야 하는지 지정해 줍니다.<br/>
CMD 명령어에 지정된 프로세스가 종료되면 컨테이너 또한 종료되므로 주의해야 합니다.

```bash
CMD ["프로세스", "매개변수 1", "매개변수 2", ...]
```

## Dockerfile 빌드

Dockerfile의 작성이 완료되었으므로 파일을 빌드해 실제 이미지를 생성해 보겠습니다.

```bash
docker build -t <이미지명> .
```

Dockerfile이 존재하는 경로에서 상단의 명령을 실행하면 <이미지명>을 가진 이미지가 생성됩니다.


